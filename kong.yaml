# kong.yaml - Declarative config for 0debt API Gateway

_format_version: "3.0"

# -----------------------------------------------------------------------------
# 1. SERVICES
# -----------------------------------------------------------------------------
services:
  - name: users-service
    url: http://users-service:3000

  - name: groups-service
    url: http://groups-service:3000

  - name: expenses-service
    url: http://expenses-service:3000

  - name: analytics-service
    url: http://analytics-service:3000
  
  # notifications-service is not exposed here because its primary communication is internal (called by users-service) and asynchronous (listening to Redis).

# -----------------------------------------------------------------------------
# 2. ROUTES 
# -----------------------------------------------------------------------------
routes:
  # --- Routes for USERS-SERVICE ---
  - name: auth-route
    service: users-service
    paths:
      - /auth
    strip_path: true

  # Protected by JWT.
  - name: users-route
    service: users-service
    paths:
      - /users
    strip_path: true

  # Protected by JWT.
  - name: groups-route
    service: groups-service
    paths:
      - /groups
    strip_path: true

  - name: expenses-route
    service: expenses-service
    paths:
      - /expenses
      - /balances
    strip_path: true
    
  - name: analytics-route
    service: analytics-service
    paths:
      - /budgets
    strip_path: true

# -----------------------------------------------------------------------------
# 3. CONSUMERS (Who the policies are for)
# -----------------------------------------------------------------------------
consumers:
  - username: plan_free_user
  - username: plan_pro_user

# -----------------------------------------------------------------------------
# 4. JWT CONFIGURATION (working declaration)
# -----------------------------------------------------------------------------
jwt_secrets:
  - consumer: plan_free_user
    key: default
    secret: ${JWT_SECRET}
    algorithm: HS256

# -----------------------------------------------------------------------------
# 5. PLUGINS
# -----------------------------------------------------------------------------
plugins:
  # --- PLUGIN JWT: Edge Security ---
  - name: jwt
    service: users-service
  - name: jwt
    service: groups-service
  - name: jwt
    service: expenses-service
  - name: jwt
    service: analytics-service
        
  # --- PLUGIN RATE-LIMITING: Throttling by Pricing Plan ---
  - name: rate-limiting
    consumer: plan_free_user
    config:
      minute: 60      
      hour: 500
      policy: local

  - name: rate-limiting
    consumer: plan_pro_user
    config:
      minute: 1000   
      hour: 10000
      policy: local

  # --- PLUGIN CORS: Connection with the Frontend ---
  - name: cors
    config:
      origins:
        - http://localhost:3000   
        - https://www.0debt.xyz   
        - https://0debt.xyz   
      methods: [GET, POST, PUT, DELETE, OPTIONS]
      headers: [Authorization, Content-Type]
      exposed_headers: [X-RateLimit-Remaining-Minute, X-RateLimit-Remaining-Hour]
      credentials: true