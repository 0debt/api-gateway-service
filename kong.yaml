# kong.yaml - Declarative config for 0debt API Gateway

_format_version: "3.0"

# -----------------------------------------------------------------------------
# 1. SERVICES
# -----------------------------------------------------------------------------
services:
  - name: users-service
    url: http://users-service:3000/api/v1

  - name: groups-service
    url: http://groups-service:3000/api

  - name: expenses-service
    url: http://expenses-service:3000/api/v1

  - name: analytics-service
    url: http://analytics-service:3000
  
  - name: notifications-service
    url: http://notifications-service:3000
  
# -----------------------------------------------------------------------------
# 2. ROUTES (strip_path: false to keep the full path)
# -----------------------------------------------------------------------------
routes:
  # --- Routes for USERS-SERVICE ---
  # Auth route - PUBLIC (no JWT)
  - name: auth-route
    service: users-service
    paths:
      - /auth
    strip_path: false

  # Users route - PROTECTED by JWT
  - name: users-route
    service: users-service
    paths:
      - /users
    strip_path: false

  # --- Routes for GROUPS-SERVICE ---
  - name: groups-route
    service: groups-service
    paths:
      - /api/groups
    strip_path: false

  # --- Routes for EXPENSES-SERVICE ---
  - name: expenses-route
    service: expenses-service
    paths:
      - /expenses
      - /balances
    strip_path: false
    
  # --- Routes for ANALYTICS-SERVICE ---
  - name: analytics-route
    service: analytics-service
    paths:
      - /v1/budgets
      - /v1/health
      - /v1/internal/users
    strip_path: false

  # --- Routes for NOTIFICATIONS-SERVICE ---
  - name: notifications-route
    service: notifications-service
    paths:
      - /notifications
      - /preferences
    strip_path: false

# -----------------------------------------------------------------------------
# 3. CONSUMERS (Who the policies are for)
# -----------------------------------------------------------------------------
consumers:
  - username: plan_free_user
  - username: plan_pro_user
  - username: plan_enterprise_user

# -----------------------------------------------------------------------------
# 4. JWT CONFIGURATION (working declaration)
# -----------------------------------------------------------------------------
jwt_secrets:
  - consumer: plan_free_user
    key: free
    secret: "{vault://env/JWT_SECRET}"
    algorithm: HS256

  - consumer: plan_pro_user
    key: pro
    secret: "{vault://env/JWT_SECRET}"
    algorithm: HS256

  - consumer: plan_enterprise_user
    key: enterprise
    secret: "{vault://env/JWT_SECRET}"
    algorithm: HS256

# -----------------------------------------------------------------------------
# 5. PLUGINS
# -----------------------------------------------------------------------------
plugins:
  # --- PLUGIN JWT: Only on protected routes (NOT on auth-route) ---
  - name: jwt
    route: users-route
  - name: jwt
    route: groups-route
  - name: jwt
    route: expenses-route
  - name: jwt
    route: analytics-route
  - name: jwt
    route: notifications-route
        
  # --- PLUGIN RATE-LIMITING: Throttling by Pricing Plan ---
  - name: rate-limiting
    consumer: plan_free_user
    config:
      minute: 60      
      hour: 500
      policy: local

  - name: rate-limiting
    consumer: plan_pro_user
    config:
      minute: 1000   
      hour: 10000
      policy: local

  - name: rate-limiting
    consumer: plan_enterprise_user
    config:
      minute: 5000   
      hour: 50000
      policy: local

  # --- PLUGIN CORS: Connection with the Frontend ---
  - name: cors
    config:
      origins:
        - http://localhost:3000   
        - https://www.0debt.xyz   
        - https://0debt.xyz   
      methods: [GET, POST, PUT, DELETE, PATCH, OPTIONS]
      headers: [Authorization, Content-Type]
      exposed_headers: [X-RateLimit-Remaining-Minute, X-RateLimit-Remaining-Hour]
      credentials: true
